version: "3"
services:
  app:
    build:
      context: .
      dockerfile: ./docker/php/Dockerfile
      args:
        - TZ=${TZ}
    # ports:
    #   - ${APP_PORT}:8000
    volumes:
      - ./server:/work
      - ./logs:/var/log/php
      - ./docker/php/php.ini:/usr/local/etc/php/php.ini
    working_dir: /work
    environment:
      - APP_PORT=8000
      - DB_CONNECTION=mysql
      - DB_HOST=db
      - DB_PORT=3306
      - DB_DATABASE=${DB_NAME:-homestead}
      - DB_USERNAME=${DB_USER:-homestead}
      - DB_PASSWORD=${DB_PASS:-secret}
      - TZ=${TZ:-Asia/Tokyo}

  web:
    build:
      context: .
      dockerfile: ./docker/nginx/Dockerfile
    depends_on:
      - app
    ports:
      - ${WEB_PORT:-80}:80
    volumes:
      - ./server:/work
      - ./logs:/var/log/nginx
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
    environment:
      - TZ=${TZ:-Asia/Tokyo}

  db:
    image: mysql:8.0
    volumes:
      - db-store:/var/lib/mysql
      - ./logs:/var/log/mysql
      - ./docker/mysql/my.cnf:/etc/mysql/conf.d/my.cnf
    environment:
      - MYSQL_DATABASE=${DB_NAME:-homestead}
      - MYSQL_USER=${DB_USER:-homestead}
      - MYSQL_PASSWORD=${DB_PASS:-secret}
      - MYSQL_ROOT_PASSWORD=${DB_PASS:-secret}
      - TZ=${TZ:-Asia/Tokyo}
    # ports:
    #   - ${DB_PORT:-13306}:3306

volumes:
  db-store:

# volumes:
#   php-fpm-socket:
#   db-store:
#   psysh-store:
# services:
#   app:
#     build:
#       context: .
#       dockerfile: ./docker/php/Dockerfile
#     volumes:
#       - type: volume
#         source: php-fpm-socket
#         target: /var/run/php-fpm
#         volume:
#           nocopy: true
#       - type: bind
#         source: ./backend
#         target: /work/backend
#       - type: volume
#         source: psysh-store
#         target: /root/.config/psysh
#         volume:
#           nocopy: true
#     environment:
#       - DB_CONNECTION=mysql
#       - DB_HOST=db
#       - DB_PORT=3306
#       - DB_DATABASE=${DB_NAME:-laravel_local}
#       - DB_USERNAME=${DB_USER:-phper}
#       - DB_PASSWORD=${DB_PASS:-secret}

#   web:
#     build:
#       context: .
#       dockerfile: ./docker/nginx/Dockerfile
#     ports:
#       - target: 80
#         published: ${WEB_PORT:-80}
#         protocol: tcp
#         mode: host
#     volumes:
#       - type: volume
#         source: php-fpm-socket
#         target: /var/run/php-fpm
#         volume:
#           nocopy: true
#       - type: bind
#         source: ./backend
#         target: /work/backend

#   db:
#     build:
#       context: .
#       dockerfile: ./docker/mysql/Dockerfile
#     ports:
#       - target: 3306
#         published: ${DB_PORT:-3306}
#         protocol: tcp
#         mode: host
#     volumes:
#       - type: volume
#         source: db-store
#         target: /var/lib/mysql
#         volume:
#           nocopy: true
#     environment:
#       - MYSQL_DATABASE=${DB_NAME:-laravel_local}
#       - MYSQL_USER=${DB_USER:-phper}
#       - MYSQL_PASSWORD=${DB_PASS:-secret}
#       - MYSQL_ROOT_PASSWORD=${DB_PASS:-secret}

